#!python

import argparse
import os
import sys
import shutil

import pandas as pd
import seaborn as sns

import hicutils as hu


if __name__ == '__main__':
    parser = argparse.ArgumentParser('Run quality control on IgBLAST output')
    parser.add_argument('directories', nargs='+')
    parser.add_argument('--output', default='./output')
    parser.add_argument('--overwrite', action='store_true', default=False)

    parser.add_argument('--clone-features', type=str, nargs='+',
                        default=['cdr3_aa'])

    parser.add_argument('--sim-std-cut', type=float, default=3)
    parser.add_argument('--sim-size', type=int, default=35)
    args = parser.parse_args()
    print(args)

    if os.path.isdir(args.output):
        if not args.overwrite:
            hu.logger.error(
                f'Directory {args.output} already exists.  Manually delete'
                'or pass the "--overwrite" flag'
            )
            sys.exit()
        else:
            shutil.rmtree(args.output)
            hu.logger.info(f'Deleted directory {args.output}')

    hu.logger.info(f'Creating output directory {args.output}')
    os.makedirs(args.output)

    hu.logger.info(f'Loading data from {", ".join(args.directories)}')
    df = pd.concat([hu.io.convert_igblast(d) for d in args.directories])

    # Clone counts
    hu.logger.info('Plotting clone sizes')
    pdf = (
        df.groupby('replicate_name')
        .clone_id.nunique()
        .to_frame()
        .reset_index()
        .sort_values('replicate_name')
    )

    g = sns.catplot(
        data=pdf,
        x='replicate_name',
        y='clone_id',
        kind='bar',
        height=8,
        aspect=2,
    )
    g.set(xlabel='Replicate', ylabel='# Clones')
    g.axes[0][0].set_xticklabels(g.axes[0][0].get_xticklabels(), rotation=90)
    hu.io.save_fig_and_data('clone_size', pdf, path=args.output)

    # Similarity
    for metric in ('cosine', 'jaccard'):
        hu.logger.info(f'Plotting {metric} similarity')
        try:
            g, pdf = hu.plots.plot_similarity(
                df,
                ['replicate_name'],
                metric,
                clone_features=args.clone_features,
                figsize=(args.sim_size, args.sim_size),
                cutoff_func=lambda df: df.stack().std() * args.sim_std_cut,
            )
            hu.io.save_fig_and_data(
                f'similarity_{metric}', pdf, path=args.output
            )
        except IndexError:
            hu.logger.warning(
                'Similarity not calculated as there was only one replicate'
            )

    # String plots
    hu.logger.info('Plotting string plots')
    try:
        g, pdf = hu.plots.plot_strings(
            df,
            'replicate_name',
            overlapping_features=args.clone_features,
            scale='log',
            col_order=lambda s: sorted(s.columns),
            figsize=(30, 30),
        )
        hu.io.save_fig_and_data(
            'overlap_string', pdf, path=args.output, ext='png'
        )
    except IndexError:
        hu.logger.warning(
            'Similarity not calculated as there was only one replicate'
        )
